/**
 * 八字批命功能 - 常量定义
 *
 * 本文件包含八字计算所需的所有常量数据
 */

import { WuXing, YinYang, ShiShen } from '../types/bazi';

// ==================== 十天干 ====================

/**
 * 十天干数组
 */
export const TIAN_GAN = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'] as const;

/**
 * 十二地支数组
 */
export const DI_ZHI = [
  '子', '丑', '寅', '卯', '辰', '巳',
  '午', '未', '申', '酉', '戌', '亥'
] as const;

// ==================== 五行对应 ====================

/**
 * 天干对应五行
 */
export const TIAN_GAN_WU_XING: Record<string, WuXing> = {
  '甲': '木',
  '乙': '木',
  '丙': '火',
  '丁': '火',
  '戊': '土',
  '己': '土',
  '庚': '金',
  '辛': '金',
  '壬': '水',
  '癸': '水'
};

/**
 * 地支对应五行
 */
export const DI_ZHI_WU_XING: Record<string, WuXing> = {
  '子': '水',
  '丑': '土',
  '寅': '木',
  '卯': '木',
  '辰': '土',
  '巳': '火',
  '午': '火',
  '未': '土',
  '申': '金',
  '酉': '金',
  '戌': '土',
  '亥': '水'
};

// ==================== 阴阳属性 ====================

/**
 * 天干阴阳属性
 */
export const TIAN_GAN_YIN_YANG: Record<string, YinYang> = {
  '甲': '阳',
  '乙': '阴',
  '丙': '阳',
  '丁': '阴',
  '戊': '阳',
  '己': '阴',
  '庚': '阳',
  '辛': '阴',
  '壬': '阳',
  '癸': '阴'
};

/**
 * 地支阴阳属性
 */
export const DI_ZHI_YIN_YANG: Record<string, YinYang> = {
  '子': '阳',
  '丑': '阴',
  '寅': '阳',
  '卯': '阴',
  '辰': '阳',
  '巳': '阴',
  '午': '阳',
  '未': '阴',
  '申': '阳',
  '酉': '阴',
  '戌': '阳',
  '亥': '阴'
};

// ==================== 地支藏干 ====================

/**
 * 地支藏干（地支中包含的天干）
 * 规则：每个地支可藏1-3个天干
 */
export const DI_ZHI_CANG_GAN: Record<string, string[]> = {
  '子': ['癸'],              // 子中只藏癸水
  '丑': ['己', '癸', '辛'],  // 丑中藏己土、癸水、辛金
  '寅': ['甲', '丙', '戊'],  // 寅中藏甲木、丙火、戊土
  '卯': ['乙'],              // 卯中只藏乙木
  '辰': ['戊', '乙', '癸'],  // 辰中藏戊土、乙木、癸水
  '巳': ['丙', '戊', '庚'],  // 巳中藏丙火、戊土、庚金
  '午': ['丁', '己'],        // 午中藏丁火、己土
  '未': ['己', '丁', '乙'],  // 未中藏己土、丁火、乙木
  '申': ['庚', '壬', '戊'],  // 申中藏庚金、壬水、戊土
  '酉': ['辛'],              // 酉中只藏辛金
  '戌': ['戊', '辛', '丁'],  // 戌中藏戊土、辛金、丁火
  '亥': ['壬', '甲']         // 亥中藏壬水、甲木
};

// ==================== 年上起月表（五虎遁月诀） ====================

/**
 * 年上起月口诀：
 * 甲己之年丙作首，乙庚之岁戊为头
 * 丙辛必定寻庚起，丁壬壬位顺行流
 * 若问戊癸何方发，甲寅之上好追求
 *
 * 即：根据年干确定正月（寅月）的天干
 */
export const YEAR_MONTH_TABLE: Record<string, string> = {
  '甲': '丙',  // 甲年或己年，正月为丙寅
  '己': '丙',
  '乙': '戊',  // 乙年或庚年，正月为戊寅
  '庚': '戊',
  '丙': '庚',  // 丙年或辛年，正月为庚寅
  '辛': '庚',
  '丁': '壬',  // 丁年或壬年，正月为壬寅
  '壬': '壬',
  '戊': '甲',  // 戊年或癸年，正月为甲寅
  '癸': '甲'
};

// ==================== 日上起时表（五鼠遁时诀） ====================

/**
 * 日上起时口诀：
 * 甲己还加甲，乙庚丙作初
 * 丙辛从戊起，丁壬庚子居
 * 戊癸何方发，壬子是真途
 *
 * 即：根据日干确定子时的天干
 */
export const DAY_HOUR_TABLE: Record<string, string> = {
  '甲': '甲',  // 甲日或己日，子时为甲子
  '己': '甲',
  '乙': '丙',  // 乙日或庚日，子时为丙子
  '庚': '丙',
  '丙': '戊',  // 丙日或辛日，子时为戊子
  '辛': '戊',
  '丁': '庚',  // 丁日或壬日，子时为庚子
  '壬': '庚',
  '戊': '壬',  // 戊日或癸日，子时为壬子
  '癸': '壬'
};

// ==================== 五行相生相克 ====================

/**
 * 五行相生关系
 * 木生火，火生土，土生金，金生水，水生木
 */
export const WU_XING_SHENG: Record<WuXing, WuXing> = {
  '木': '火',
  '火': '土',
  '土': '金',
  '金': '水',
  '水': '木'
};

/**
 * 五行相克关系
 * 木克土，土克水，水克火，火克金，金克木
 */
export const WU_XING_KE: Record<WuXing, WuXing> = {
  '木': '土',
  '土': '水',
  '水': '火',
  '火': '金',
  '金': '木'
};

/**
 * 判断五行A是否生五行B
 */
export function wuXingGenerates(from: WuXing, to: WuXing): boolean {
  return WU_XING_SHENG[from] === to;
}

/**
 * 判断五行A是否克五行B
 */
export function wuXingControls(from: WuXing, to: WuXing): boolean {
  return WU_XING_KE[from] === to;
}

// ==================== 十神推算规则 ====================

/**
 * 十神推算矩阵
 * 根据日干五行和目标干支五行、阴阳关系，确定十神
 *
 * 规则：
 * 1. 同五行同阴阳 → 比肩
 * 2. 同五行异阴阳 → 劫财
 * 3. 我生且同阴阳 → 食神
 * 4. 我生且异阴阳 → 伤官
 * 5. 我克且同阴阳 → 偏财
 * 6. 我克且异阴阳 → 正财
 * 7. 克我且同阴阳 → 偏官（七杀）
 * 8. 克我且异阴阳 → 正官
 * 9. 生我且同阴阳 → 偏印（枭神）
 * 10. 生我且异阴阳 → 正印
 */

// ==================== 地支关系 ====================

/**
 * 地支六合（两两相合）
 * 子丑合土、寅亥合木、卯戌合火、辰酉合金、巳申合水、午未合（太阳太阴合）
 */
export const DI_ZHI_LIU_HE: Array<[string, string]> = [
  ['子', '丑'],
  ['寅', '亥'],
  ['卯', '戌'],
  ['辰', '酉'],
  ['巳', '申'],
  ['午', '未']
];

/**
 * 地支三合（三个地支合成五行局）
 * 申子辰合水局、亥卯未合木局、寅午戌合火局、巳酉丑合金局
 */
export const DI_ZHI_SAN_HE: Array<[string, string, string]> = [
  ['申', '子', '辰'],  // 合水局
  ['亥', '卯', '未'],  // 合木局
  ['寅', '午', '戌'],  // 合火局
  ['巳', '酉', '丑']   // 合金局
];

/**
 * 地支六冲（相对位置，相互冲克）
 * 子午冲、丑未冲、寅申冲、卯酉冲、辰戌冲、巳亥冲
 */
export const DI_ZHI_LIU_CHONG: Array<[string, string]> = [
  ['子', '午'],
  ['丑', '未'],
  ['寅', '申'],
  ['卯', '酉'],
  ['辰', '戌'],
  ['巳', '亥']
];

/**
 * 地支三刑
 * 子卯刑、寅巳申三刑、丑戌未三刑、辰午酉亥自刑
 */
export const DI_ZHI_SAN_XING: Array<string[]> = [
  ['子', '卯'],           // 无礼之刑
  ['寅', '巳', '申'],     // 恃势之刑
  ['丑', '戌', '未'],     // 无恩之刑
  ['辰', '辰'],           // 自刑
  ['午', '午'],           // 自刑
  ['酉', '酉'],           // 自刑
  ['亥', '亥']            // 自刑
];

/**
 * 地支相害（六害）
 * 子未害、丑午害、寅巳害、卯辰害、申亥害、酉戌害
 */
export const DI_ZHI_XIANG_HAI: Array<[string, string]> = [
  ['子', '未'],
  ['丑', '午'],
  ['寅', '巳'],
  ['卯', '辰'],
  ['申', '亥'],
  ['酉', '戌']
];

// ==================== 纳音五行 ====================

/**
 * 六十甲子纳音表
 * 每两个干支一组，共30组
 */
export const NA_YIN_TABLE: Record<string, string> = {
  '甲子': '海中金', '乙丑': '海中金',
  '丙寅': '炉中火', '丁卯': '炉中火',
  '戊辰': '大林木', '己巳': '大林木',
  '庚午': '路旁土', '辛未': '路旁土',
  '壬申': '剑锋金', '癸酉': '剑锋金',
  '甲戌': '山头火', '乙亥': '山头火',
  '丙子': '涧下水', '丁丑': '涧下水',
  '戊寅': '城墙土', '己卯': '城墙土',
  '庚辰': '白蜡金', '辛巳': '白蜡金',
  '壬午': '杨柳木', '癸未': '杨柳木',
  '甲申': '泉中水', '乙酉': '泉中水',
  '丙戌': '屋上土', '丁亥': '屋上土',
  '戊子': '霹雳火', '己丑': '霹雳火',
  '庚寅': '松柏木', '辛卯': '松柏木',
  '壬辰': '长流水', '癸巳': '长流水',
  '甲午': '沙中金', '乙未': '沙中金',
  '丙申': '山下火', '丁酉': '山下火',
  '戊戌': '平地木', '己亥': '平地木',
  '庚子': '壁上土', '辛丑': '壁上土',
  '壬寅': '金箔金', '癸卯': '金箔金',
  '甲辰': '覆灯火', '乙巳': '覆灯火',
  '丙午': '天河水', '丁未': '天河水',
  '戊申': '大驿土', '己酉': '大驿土',
  '庚戌': '钗钏金', '辛亥': '钗钏金',
  '壬子': '桑柘木', '癸丑': '桑柘木',
  '甲寅': '大溪水', '乙卯': '大溪水',
  '丙辰': '沙中土', '丁巳': '沙中土',
  '戊午': '天上火', '己未': '天上火',
  '庚申': '石榴木', '辛酉': '石榴木',
  '壬戌': '大海水', '癸亥': '大海水'
};

// ==================== 时辰对应 ====================

/**
 * 时辰对应地支
 * 23-1点为子时，1-3点为丑时，以此类推
 */
export const HOUR_TO_ZHI: Record<number, string> = {
  23: '子', 0: '子',    // 23:00 - 00:59
  1: '丑', 2: '丑',     // 01:00 - 02:59
  3: '寅', 4: '寅',     // 03:00 - 04:59
  5: '卯', 6: '卯',     // 05:00 - 06:59
  7: '辰', 8: '辰',     // 07:00 - 08:59
  9: '巳', 10: '巳',    // 09:00 - 10:59
  11: '午', 12: '午',   // 11:00 - 12:59
  13: '未', 14: '未',   // 13:00 - 14:59
  15: '申', 16: '申',   // 15:00 - 16:59
  17: '酉', 18: '酉',   // 17:00 - 18:59
  19: '戌', 20: '戌',   // 19:00 - 20:59
  21: '亥', 22: '亥'    // 21:00 - 22:59
};

/**
 * 根据小时数获取地支
 */
export function getZhiByHour(hour: number): string {
  return HOUR_TO_ZHI[hour] || '子';
}

// ==================== 工具函数 ====================

/**
 * 获取干支的纳音
 */
export function getNaYin(ganZhi: string): string {
  return NA_YIN_TABLE[ganZhi] || '';
}

/**
 * 判断两个地支是否六合
 */
export function isLiuHe(zhi1: string, zhi2: string): boolean {
  return DI_ZHI_LIU_HE.some(
    ([a, b]) => (a === zhi1 && b === zhi2) || (a === zhi2 && b === zhi1)
  );
}

/**
 * 判断两个地支是否六冲
 */
export function isLiuChong(zhi1: string, zhi2: string): boolean {
  return DI_ZHI_LIU_CHONG.some(
    ([a, b]) => (a === zhi1 && b === zhi2) || (a === zhi2 && b === zhi1)
  );
}

/**
 * 判断三个地支是否三合
 */
export function isSanHe(zhi1: string, zhi2: string, zhi3: string): boolean {
  const zhiSet = new Set([zhi1, zhi2, zhi3]);
  return DI_ZHI_SAN_HE.some(([a, b, c]) => {
    const groupSet = new Set([a, b, c]);
    return (
      zhiSet.size === 3 &&
      Array.from(zhiSet).every(z => groupSet.has(z))
    );
  });
}

// ==================== 神煞查法常量 ====================

/**
 * 天乙贵人查法表
 * 口诀：甲戊庚牛羊，乙己鼠猴乡，丙丁猪鸡位，壬癸兔蛇藏，六辛逢虎马
 * 以日干查四柱地支，见之为贵人
 */
export const TIAN_YI_GUI_REN: Record<string, string[]> = {
  '甲': ['丑', '未'],  // 甲戊庚牛羊
  '戊': ['丑', '未'],
  '庚': ['丑', '未'],
  '乙': ['子', '申'],  // 乙己鼠猴乡
  '己': ['子', '申'],
  '丙': ['亥', '酉'],  // 丙丁猪鸡位
  '丁': ['亥', '酉'],
  '壬': ['卯', '巳'],  // 壬癸兔蛇藏
  '癸': ['卯', '巳'],
  '辛': ['寅', '午']   // 六辛逢虎马
};

/**
 * 天德贵人查法表
 * 按月份地支查地支，月份以节气为准
 */
export const TIAN_DE_GUI_REN: Record<string, string> = {
  '寅': '丁',  // 正月（寅月）
  '卯': '申',  // 二月（卯月）
  '辰': '壬',  // 三月（辰月）
  '巳': '辛',  // 四月（巳月）
  '午': '亥',  // 五月（午月）
  '未': '甲',  // 六月（未月）
  '申': '癸',  // 七月（申月）
  '酉': '寅',  // 八月（酉月）
  '戌': '丙',  // 九月（戌月）
  '亥': '乙',  // 十月（亥月）
  '子': '巳',  // 十一月（子月）
  '丑': '庚'   // 十二月（丑月）
};

/**
 * 月德贵人查法表
 * 按月份地支查地支
 */
export const YUE_DE_GUI_REN: Record<string, string> = {
  '寅': '丙',  // 正月建寅
  '卯': '甲',  // 二月建卯
  '辰': '壬',  // 三月建辰
  '巳': '庚',  // 四月建巳
  '午': '丙',  // 五月建午
  '未': '甲',  // 六月建未
  '申': '壬',  // 七月建申
  '酉': '庚',  // 八月建酉
  '戌': '丙',  // 九月建戌
  '亥': '甲',  // 十月建亥
  '子': '壬',  // 十一月建子
  '丑': '庚'   // 十二月建丑
};

/**
 * 文昌贵人查法表
 * 以日干查地支
 */
export const WEN_CHANG_GUI_REN: Record<string, string> = {
  '甲': '巳',
  '乙': '午',
  '丙': '申',
  '丁': '酉',
  '戊': '申',
  '己': '酉',
  '庚': '亥',
  '辛': '子',
  '壬': '寅',
  '癸': '卯'
};

/**
 * 禄神查法表
 * 以日干查地支（临官位）
 */
export const LU_SHEN: Record<string, string> = {
  '甲': '寅',  // 甲禄在寅
  '乙': '卯',  // 乙禄在卯
  '丙': '巳',  // 丙禄在巳
  '丁': '午',  // 丁禄在午
  '戊': '巳',  // 戊禄在巳
  '己': '午',  // 己禄在午
  '庚': '申',  // 庚禄在申
  '辛': '酉',  // 辛禄在酉
  '壬': '亥',  // 壬禄在亥
  '癸': '子'   // 癸禄在子
};

/**
 * 红鸾查法表
 * 以年支查地支（对冲位）
 */
export const HONG_LUAN: Record<string, string> = {
  '子': '卯',
  '丑': '寅',
  '寅': '丑',
  '卯': '子',
  '辰': '亥',
  '巳': '戌',
  '午': '酉',
  '未': '申',
  '申': '未',
  '酉': '午',
  '戌': '巳',
  '亥': '辰'
};

/**
 * 天喜查法表
 * 红鸾对冲位
 */
export const TIAN_XI: Record<string, string> = {
  '子': '酉',
  '丑': '申',
  '寅': '未',
  '卯': '午',
  '辰': '巳',
  '巳': '辰',
  '午': '卯',
  '未': '寅',
  '申': '丑',
  '酉': '子',
  '戌': '亥',
  '亥': '戌'
};

/**
 * 羊刃查法表
 * 以日干查地支（帝旺后一位）
 */
export const YANG_REN: Record<string, string> = {
  '甲': '卯',  // 甲木帝旺在卯，羊刃在卯
  '乙': '寅',  // 乙木帝旺在寅，羊刃在寅（阴干取逆）
  '丙': '午',  // 丙火帝旺在午
  '丁': '巳',  // 丁火帝旺在巳（阴干取逆）
  '戊': '午',  // 戊土帝旺在午
  '己': '巳',  // 己土帝旺在巳（阴干取逆）
  '庚': '酉',  // 庚金帝旺在酉
  '辛': '申',  // 辛金帝旺在申（阴干取逆）
  '壬': '子',  // 壬水帝旺在子
  '癸': '亥'   // 癸水帝旺在亥（阴干取逆）
};

/**
 * 桃花查法表
 * 以日支或年支查，口诀：申子辰酉，寅午戌卯，巳酉丑午，亥卯未子
 */
export const TAO_HUA: Record<string, string> = {
  '申': '酉',  // 申子辰马在寅，桃花在酉
  '子': '酉',
  '辰': '酉',
  '寅': '卯',  // 寅午戌马在申，桃花在卯
  '午': '卯',
  '戌': '卯',
  '巳': '午',  // 巳酉丑马在亥，桃花在午
  '酉': '午',
  '丑': '午',
  '亥': '子',  // 亥卯未马在巳，桃花在子
  '卯': '子',
  '未': '子'
};

/**
 * 孤辰查法表
 * 以年支查地支
 */
export const GU_CHEN: Record<string, string> = {
  '亥': '寅',  // 亥子丑人，寅为孤
  '子': '寅',
  '丑': '寅',
  '寅': '巳',  // 寅卯辰人，巳为孤
  '卯': '巳',
  '辰': '巳',
  '巳': '申',  // 巳午未人，申为孤
  '午': '申',
  '未': '申',
  '申': '亥',  // 申酉戌人，亥为孤
  '酉': '亥',
  '戌': '亥'
};

/**
 * 寡宿查法表
 * 孤辰对冲位
 */
export const GUA_SU: Record<string, string> = {
  '亥': '戌',  // 亥子丑人，戌为寡
  '子': '戌',
  '丑': '戌',
  '寅': '丑',  // 寅卯辰人，丑为寡
  '卯': '丑',
  '辰': '丑',
  '巳': '辰',  // 巳午未人，辰为寡
  '午': '辰',
  '未': '辰',
  '申': '未',  // 申酉戌人，未为寡
  '酉': '未',
  '戌': '未'
};

/**
 * 劫煞查法表
 * 以日支或年支查，口诀：申子辰见巳，寅午戌见亥，巳酉丑见申，亥卯未见寅
 */
export const JIE_SHA: Record<string, string> = {
  '申': '巳',
  '子': '巳',
  '辰': '巳',
  '寅': '亥',
  '午': '亥',
  '戌': '亥',
  '巳': '申',
  '酉': '申',
  '丑': '申',
  '亥': '寅',
  '卯': '寅',
  '未': '寅'
};

/**
 * 灾煞查法表
 * 以日支或年支查，口诀：申子辰见午，寅午戌见子，巳酉丑见卯，亥卯未见酉
 */
export const ZAI_SHA: Record<string, string> = {
  '申': '午',
  '子': '午',
  '辰': '午',
  '寅': '子',
  '午': '子',
  '戌': '子',
  '巳': '卯',
  '酉': '卯',
  '丑': '卯',
  '亥': '酉',
  '卯': '酉',
  '未': '酉'
};

/**
 * 驿马查法表
 * 以日支或年支查，口诀：申子辰马在寅，寅午戌马在申，巳酉丑马在亥，亥卯未马在巳
 */
export const YI_MA: Record<string, string> = {
  '申': '寅',
  '子': '寅',
  '辰': '寅',
  '寅': '申',
  '午': '申',
  '戌': '申',
  '巳': '亥',
  '酉': '亥',
  '丑': '亥',
  '亥': '巳',
  '卯': '巳',
  '未': '巳'
};

/**
 * 华盖查法表
 * 以日支或年支查，辰戌丑未为华盖
 */
export const HUA_GAI: Record<string, string> = {
  '申': '辰',
  '子': '辰',
  '辰': '辰',
  '寅': '戌',
  '午': '戌',
  '戌': '戌',
  '巳': '丑',
  '酉': '丑',
  '丑': '丑',
  '亥': '未',
  '卯': '未',
  '未': '未'
};
