/**
 * 八字批命功能 - 常量定义
 *
 * 本文件包含八字计算所需的所有常量数据
 */

import { WuXing, YinYang, ShiShen } from '../types/bazi';

// ==================== 十天干 ====================

/**
 * 十天干数组
 */
export const TIAN_GAN = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'] as const;

/**
 * 十二地支数组
 */
export const DI_ZHI = [
  '子', '丑', '寅', '卯', '辰', '巳',
  '午', '未', '申', '酉', '戌', '亥'
] as const;

// ==================== 五行对应 ====================

/**
 * 天干对应五行
 */
export const TIAN_GAN_WU_XING: Record<string, WuXing> = {
  '甲': '木',
  '乙': '木',
  '丙': '火',
  '丁': '火',
  '戊': '土',
  '己': '土',
  '庚': '金',
  '辛': '金',
  '壬': '水',
  '癸': '水'
};

/**
 * 地支对应五行
 */
export const DI_ZHI_WU_XING: Record<string, WuXing> = {
  '子': '水',
  '丑': '土',
  '寅': '木',
  '卯': '木',
  '辰': '土',
  '巳': '火',
  '午': '火',
  '未': '土',
  '申': '金',
  '酉': '金',
  '戌': '土',
  '亥': '水'
};

// ==================== 阴阳属性 ====================

/**
 * 天干阴阳属性
 */
export const TIAN_GAN_YIN_YANG: Record<string, YinYang> = {
  '甲': '阳',
  '乙': '阴',
  '丙': '阳',
  '丁': '阴',
  '戊': '阳',
  '己': '阴',
  '庚': '阳',
  '辛': '阴',
  '壬': '阳',
  '癸': '阴'
};

/**
 * 地支阴阳属性
 */
export const DI_ZHI_YIN_YANG: Record<string, YinYang> = {
  '子': '阳',
  '丑': '阴',
  '寅': '阳',
  '卯': '阴',
  '辰': '阳',
  '巳': '阴',
  '午': '阳',
  '未': '阴',
  '申': '阳',
  '酉': '阴',
  '戌': '阳',
  '亥': '阴'
};

// ==================== 地支藏干 ====================

/**
 * 地支藏干（地支中包含的天干）
 * 规则：每个地支可藏1-3个天干
 */
export const DI_ZHI_CANG_GAN: Record<string, string[]> = {
  '子': ['癸'],              // 子中只藏癸水
  '丑': ['己', '癸', '辛'],  // 丑中藏己土、癸水、辛金
  '寅': ['甲', '丙', '戊'],  // 寅中藏甲木、丙火、戊土
  '卯': ['乙'],              // 卯中只藏乙木
  '辰': ['戊', '乙', '癸'],  // 辰中藏戊土、乙木、癸水
  '巳': ['丙', '戊', '庚'],  // 巳中藏丙火、戊土、庚金
  '午': ['丁', '己'],        // 午中藏丁火、己土
  '未': ['己', '丁', '乙'],  // 未中藏己土、丁火、乙木
  '申': ['庚', '壬', '戊'],  // 申中藏庚金、壬水、戊土
  '酉': ['辛'],              // 酉中只藏辛金
  '戌': ['戊', '辛', '丁'],  // 戌中藏戊土、辛金、丁火
  '亥': ['壬', '甲']         // 亥中藏壬水、甲木
};

// ==================== 年上起月表（五虎遁月诀） ====================

/**
 * 年上起月口诀：
 * 甲己之年丙作首，乙庚之岁戊为头
 * 丙辛必定寻庚起，丁壬壬位顺行流
 * 若问戊癸何方发，甲寅之上好追求
 *
 * 即：根据年干确定正月（寅月）的天干
 */
export const YEAR_MONTH_TABLE: Record<string, string> = {
  '甲': '丙',  // 甲年或己年，正月为丙寅
  '己': '丙',
  '乙': '戊',  // 乙年或庚年，正月为戊寅
  '庚': '戊',
  '丙': '庚',  // 丙年或辛年，正月为庚寅
  '辛': '庚',
  '丁': '壬',  // 丁年或壬年，正月为壬寅
  '壬': '壬',
  '戊': '甲',  // 戊年或癸年，正月为甲寅
  '癸': '甲'
};

// ==================== 日上起时表（五鼠遁时诀） ====================

/**
 * 日上起时口诀：
 * 甲己还加甲，乙庚丙作初
 * 丙辛从戊起，丁壬庚子居
 * 戊癸何方发，壬子是真途
 *
 * 即：根据日干确定子时的天干
 */
export const DAY_HOUR_TABLE: Record<string, string> = {
  '甲': '甲',  // 甲日或己日，子时为甲子
  '己': '甲',
  '乙': '丙',  // 乙日或庚日，子时为丙子
  '庚': '丙',
  '丙': '戊',  // 丙日或辛日，子时为戊子
  '辛': '戊',
  '丁': '庚',  // 丁日或壬日，子时为庚子
  '壬': '庚',
  '戊': '壬',  // 戊日或癸日，子时为壬子
  '癸': '壬'
};

// ==================== 五行相生相克 ====================

/**
 * 五行相生关系
 * 木生火，火生土，土生金，金生水，水生木
 */
export const WU_XING_SHENG: Record<WuXing, WuXing> = {
  '木': '火',
  '火': '土',
  '土': '金',
  '金': '水',
  '水': '木'
};

/**
 * 五行相克关系
 * 木克土，土克水，水克火，火克金，金克木
 */
export const WU_XING_KE: Record<WuXing, WuXing> = {
  '木': '土',
  '土': '水',
  '水': '火',
  '火': '金',
  '金': '木'
};

/**
 * 判断五行A是否生五行B
 */
export function wuXingGenerates(from: WuXing, to: WuXing): boolean {
  return WU_XING_SHENG[from] === to;
}

/**
 * 判断五行A是否克五行B
 */
export function wuXingControls(from: WuXing, to: WuXing): boolean {
  return WU_XING_KE[from] === to;
}

// ==================== 十神推算规则 ====================

/**
 * 十神推算矩阵
 * 根据日干五行和目标干支五行、阴阳关系，确定十神
 *
 * 规则：
 * 1. 同五行同阴阳 → 比肩
 * 2. 同五行异阴阳 → 劫财
 * 3. 我生且同阴阳 → 食神
 * 4. 我生且异阴阳 → 伤官
 * 5. 我克且同阴阳 → 偏财
 * 6. 我克且异阴阳 → 正财
 * 7. 克我且同阴阳 → 偏官（七杀）
 * 8. 克我且异阴阳 → 正官
 * 9. 生我且同阴阳 → 偏印（枭神）
 * 10. 生我且异阴阳 → 正印
 */

// ==================== 地支关系 ====================

/**
 * 地支六合（两两相合）
 * 子丑合土、寅亥合木、卯戌合火、辰酉合金、巳申合水、午未合（太阳太阴合）
 */
export const DI_ZHI_LIU_HE: Array<[string, string]> = [
  ['子', '丑'],
  ['寅', '亥'],
  ['卯', '戌'],
  ['辰', '酉'],
  ['巳', '申'],
  ['午', '未']
];

/**
 * 地支三合（三个地支合成五行局）
 * 申子辰合水局、亥卯未合木局、寅午戌合火局、巳酉丑合金局
 */
export const DI_ZHI_SAN_HE: Array<[string, string, string]> = [
  ['申', '子', '辰'],  // 合水局
  ['亥', '卯', '未'],  // 合木局
  ['寅', '午', '戌'],  // 合火局
  ['巳', '酉', '丑']   // 合金局
];

/**
 * 地支六冲（相对位置，相互冲克）
 * 子午冲、丑未冲、寅申冲、卯酉冲、辰戌冲、巳亥冲
 */
export const DI_ZHI_LIU_CHONG: Array<[string, string]> = [
  ['子', '午'],
  ['丑', '未'],
  ['寅', '申'],
  ['卯', '酉'],
  ['辰', '戌'],
  ['巳', '亥']
];

/**
 * 地支三刑
 * 子卯刑、寅巳申三刑、丑戌未三刑、辰午酉亥自刑
 */
export const DI_ZHI_SAN_XING: Array<string[]> = [
  ['子', '卯'],           // 无礼之刑
  ['寅', '巳', '申'],     // 恃势之刑
  ['丑', '戌', '未'],     // 无恩之刑
  ['辰', '辰'],           // 自刑
  ['午', '午'],           // 自刑
  ['酉', '酉'],           // 自刑
  ['亥', '亥']            // 自刑
];

/**
 * 地支相害（六害）
 * 子未害、丑午害、寅巳害、卯辰害、申亥害、酉戌害
 */
export const DI_ZHI_XIANG_HAI: Array<[string, string]> = [
  ['子', '未'],
  ['丑', '午'],
  ['寅', '巳'],
  ['卯', '辰'],
  ['申', '亥'],
  ['酉', '戌']
];

// ==================== 纳音五行 ====================

/**
 * 六十甲子纳音表
 * 每两个干支一组，共30组
 */
export const NA_YIN_TABLE: Record<string, string> = {
  '甲子': '海中金', '乙丑': '海中金',
  '丙寅': '炉中火', '丁卯': '炉中火',
  '戊辰': '大林木', '己巳': '大林木',
  '庚午': '路旁土', '辛未': '路旁土',
  '壬申': '剑锋金', '癸酉': '剑锋金',
  '甲戌': '山头火', '乙亥': '山头火',
  '丙子': '涧下水', '丁丑': '涧下水',
  '戊寅': '城墙土', '己卯': '城墙土',
  '庚辰': '白蜡金', '辛巳': '白蜡金',
  '壬午': '杨柳木', '癸未': '杨柳木',
  '甲申': '泉中水', '乙酉': '泉中水',
  '丙戌': '屋上土', '丁亥': '屋上土',
  '戊子': '霹雳火', '己丑': '霹雳火',
  '庚寅': '松柏木', '辛卯': '松柏木',
  '壬辰': '长流水', '癸巳': '长流水',
  '甲午': '沙中金', '乙未': '沙中金',
  '丙申': '山下火', '丁酉': '山下火',
  '戊戌': '平地木', '己亥': '平地木',
  '庚子': '壁上土', '辛丑': '壁上土',
  '壬寅': '金箔金', '癸卯': '金箔金',
  '甲辰': '覆灯火', '乙巳': '覆灯火',
  '丙午': '天河水', '丁未': '天河水',
  '戊申': '大驿土', '己酉': '大驿土',
  '庚戌': '钗钏金', '辛亥': '钗钏金',
  '壬子': '桑柘木', '癸丑': '桑柘木',
  '甲寅': '大溪水', '乙卯': '大溪水',
  '丙辰': '沙中土', '丁巳': '沙中土',
  '戊午': '天上火', '己未': '天上火',
  '庚申': '石榴木', '辛酉': '石榴木',
  '壬戌': '大海水', '癸亥': '大海水'
};

// ==================== 时辰对应 ====================

/**
 * 时辰对应地支
 * 23-1点为子时，1-3点为丑时，以此类推
 */
export const HOUR_TO_ZHI: Record<number, string> = {
  23: '子', 0: '子',    // 23:00 - 00:59
  1: '丑', 2: '丑',     // 01:00 - 02:59
  3: '寅', 4: '寅',     // 03:00 - 04:59
  5: '卯', 6: '卯',     // 05:00 - 06:59
  7: '辰', 8: '辰',     // 07:00 - 08:59
  9: '巳', 10: '巳',    // 09:00 - 10:59
  11: '午', 12: '午',   // 11:00 - 12:59
  13: '未', 14: '未',   // 13:00 - 14:59
  15: '申', 16: '申',   // 15:00 - 16:59
  17: '酉', 18: '酉',   // 17:00 - 18:59
  19: '戌', 20: '戌',   // 19:00 - 20:59
  21: '亥', 22: '亥'    // 21:00 - 22:59
};

/**
 * 根据小时数获取地支
 */
export function getZhiByHour(hour: number): string {
  return HOUR_TO_ZHI[hour] || '子';
}

// ==================== 工具函数 ====================

/**
 * 获取干支的纳音
 */
export function getNaYin(ganZhi: string): string {
  return NA_YIN_TABLE[ganZhi] || '';
}

/**
 * 判断两个地支是否六合
 */
export function isLiuHe(zhi1: string, zhi2: string): boolean {
  return DI_ZHI_LIU_HE.some(
    ([a, b]) => (a === zhi1 && b === zhi2) || (a === zhi2 && b === zhi1)
  );
}

/**
 * 判断两个地支是否六冲
 */
export function isLiuChong(zhi1: string, zhi2: string): boolean {
  return DI_ZHI_LIU_CHONG.some(
    ([a, b]) => (a === zhi1 && b === zhi2) || (a === zhi2 && b === zhi1)
  );
}

/**
 * 判断三个地支是否三合
 */
export function isSanHe(zhi1: string, zhi2: string, zhi3: string): boolean {
  const zhiSet = new Set([zhi1, zhi2, zhi3]);
  return DI_ZHI_SAN_HE.some(([a, b, c]) => {
    const groupSet = new Set([a, b, c]);
    return (
      zhiSet.size === 3 &&
      Array.from(zhiSet).every(z => groupSet.has(z))
    );
  });
}
