name: Docker Compose with GHCR Images

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch/Tag to deploy'
        required: true
        default: 'main'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-compose:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create docker-compose file for GHCR
        run: |
          cat > docker-compose.ghcr.yml << 'EOF'
          version: '3.8'

          services:
            mysql:
              image: mysql:5.7
              container_name: liuyao-mysql
              restart: always
              environment:
                MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
                MYSQL_DATABASE: ${MYSQL_DATABASE:-liuyao_db}
                MYSQL_USER: ${MYSQL_USER:-liuyao_user}
                MYSQL_PASSWORD: ${MYSQL_PASSWORD:-liuyao_pass}
              volumes:
                - mysql-data:/var/lib/mysql
                - ./server/sql:/docker-entrypoint-initdb.d:ro
              ports:
                - "3306:3306"
              networks:
                - liuyao-network
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
                interval: 10s
                timeout: 5s
                retries: 5

            server:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/server:${{ github.event.inputs.branch || 'latest' }}
              container_name: liuyao-server
              restart: always
              environment:
                NODE_ENV: production
                PORT: 5000
                DB_HOST: mysql
                DB_PORT: 3306
                DB_USER: ${MYSQL_USER:-liuyao_user}
                DB_PASSWORD: ${MYSQL_PASSWORD:-liuyao_pass}
                DB_NAME: ${MYSQL_DATABASE:-liuyao_db}
                JWT_SECRET: ${JWT_SECRET:-change-this-secret-in-production}
                JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
                JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-30d}
                DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
                DEEPSEEK_API_URL: ${DEEPSEEK_API_URL:-https://api.deepseek.com}
                TZ: Asia/Shanghai
              depends_on:
                mysql:
                  condition: service_healthy
              ports:
                - "5000:5000"
              networks:
                - liuyao-network
              volumes:
                - ./logs:/app/logs
                - /etc/localtime:/etc/localtime:ro
              healthcheck:
                test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/api/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s

            client:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/client:${{ github.event.inputs.branch || 'latest' }}
              container_name: liuyao-client
              restart: always
              ports:
                - "80:80"
                - "443:443"
              depends_on:
                - server
              networks:
                - liuyao-network
              volumes:
                - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro

          volumes:
            mysql-data:
              driver: local

          networks:
            liuyao-network:
              driver: bridge
          EOF
          cat docker-compose.ghcr.yml

      - name: Verify docker-compose.ghcr.yml
        run: |
          echo "Docker Compose file for GHCR created successfully"
          echo "This file uses images from GHCR instead of building locally"
