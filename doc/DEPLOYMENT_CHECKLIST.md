# 部署检查清单

在部署到生产服务器之前，请确保完成以下所有检查项：

## 📋 部署前准备

### 服务器环境
- [ ] 服务器操作系统已更新到最新版本
- [ ] Node.js 版本 >= 18.0.0
- [ ] MySQL 版本 >= 5.7 或 8.0
- [ ] Nginx 已安装并配置
- [ ] 防火墙已配置（开放 80、443、22 端口）
- [ ] 服务器内存 >= 1GB（推荐 2GB+）
- [ ] 硬盘空间 >= 10GB（推荐 20GB+）

### 数据库准备
- [ ] MySQL 已启动并设置为开机自启
- [ ] 已创建数据库 `liuyao_db`
- [ ] 已创建专用数据库用户（非root）
- [ ] 数据库用户权限已正确设置
- [ ] 已导入 `init_database.sql`
- [ ] 已导入 `insert_data.sql`
- [ ] 已导入 `auth_tables.sql`
- [ ] 已导入 `auth_init_data.sql`
- [ ] 数据库字符集为 utf8mb4

### 项目配置
- [ ] 已从 `.env.example` 复制为 `.env`
- [ ] 已修改 `DB_HOST`、`DB_USER`、`DB_PASSWORD`
- [ ] 已设置强随机 `JWT_SECRET`（使用 `openssl rand -base64 32` 生成）
- [ ] 已配置有效的 `DEEPSEEK_API_KEY`
- [ ] `NODE_ENV` 已设置为 `production`
- [ ] 已修改默认管理员密码

---

## 🔧 部署步骤

### 代码部署
- [ ] 已上传所有项目文件到服务器
- [ ] 已执行 `npm install`（根目录、client、server）
- [ ] 已构建前端：`cd client && npm run build`
- [ ] 已构建后端：`cd server && npm run build`
- [ ] 已验证 `client/dist` 和 `server/dist` 目录存在

### Nginx配置
- [ ] 已复制 `nginx.conf` 到 `/etc/nginx/sites-available/`
- [ ] 已创建软链接到 `/etc/nginx/sites-enabled/`
- [ ] 已修改配置中的域名
- [ ] 已修改前端文件路径
- [ ] 已执行 `nginx -t` 测试配置
- [ ] 已重启 Nginx

### PM2配置
- [ ] 已全局安装 PM2：`npm install -g pm2`
- [ ] 已启动应用：`pm2 start ecosystem.config.js`
- [ ] 已验证应用运行：`pm2 status`
- [ ] 已查看日志确认无错误：`pm2 logs`
- [ ] 已设置开机自启：`pm2 startup && pm2 save`

---

## 🔐 安全配置

### 密码安全
- [ ] 已修改所有默认密码（admin、testuser等）
- [ ] MySQL root密码已修改
- [ ] 数据库用户密码足够强（包含大小写、数字、符号）
- [ ] JWT_SECRET 已使用强随机值

### 系统安全
- [ ] 防火墙已启用并正确配置
- [ ] SSH 端口已修改（推荐非22端口）
- [ ] 已禁用 root SSH 登录
- [ ] 已配置 SSH 密钥认证
- [ ] 已安装 fail2ban 防暴力破解
- [ ] 已限制数据库只允许本地连接

### SSL证书
- [ ] 已申请 SSL 证书（Let's Encrypt 或其他）
- [ ] Nginx 已配置 HTTPS
- [ ] 已启用强制 HTTPS 跳转
- [ ] SSL 证书自动续期已配置

---

## 🧪 功能测试

### 基础功能
- [ ] 访问首页正常显示
- [ ] 登录功能正常
- [ ] 注册功能正常（邀请码验证生效）
- [ ] 退出登录功能正常
- [ ] 健康检查接口正常：`curl http://localhost:5000/api/health`

### 核心功能
- [ ] 时间起卦功能正常
- [ ] 数字起卦功能正常
- [ ] 手动摇卦功能正常
- [ ] 卦象显示正常
- [ ] AI解卦功能正常（需要 DeepSeek API）
- [ ] 历史记录查看正常
- [ ] 历史记录删除正常

### 工具箱功能
- [ ] 万年历查询正常
- [ ] 地支关系查询正常
- [ ] 用神速查正常
- [ ] 卦象速查正常

### 权限系统
- [ ] 管理员账号权限正常
- [ ] 普通用户权限限制正常
- [ ] 未登录状态正确跳转登录页
- [ ] Token 过期自动跳转登录页

---

## 📊 性能优化

### 前端优化
- [ ] 已启用 Gzip 压缩
- [ ] 静态资源缓存已配置
- [ ] 生产环境构建已优化（npm run build）

### 后端优化
- [ ] PM2 集群模式已启用（instances: 2+）
- [ ] 数据库连接池已配置
- [ ] API 响应时间正常（< 500ms）

### 数据库优化
- [ ] MySQL 配置已优化（innodb_buffer_pool_size 等）
- [ ] 已添加必要的索引
- [ ] 查询性能已测试

---

## 📈 监控和日志

### 日志配置
- [ ] PM2 日志正常写入：`logs/server-*.log`
- [ ] Nginx 日志正常：`/var/log/nginx/liuyao-*.log`
- [ ] MySQL 日志可访问

### 监控设置
- [ ] PM2 监控界面可用：`pm2 monit`
- [ ] 服务器资源监控已配置（可选：htop、netdata）
- [ ] 异常告警已配置（可选）

---

## 💾 备份和恢复

### 备份配置
- [ ] 数据库自动备份脚本已创建
- [ ] 代码备份策略已确定
- [ ] 备份定时任务已配置（crontab）
- [ ] 备份文件存储位置已确定
- [ ] 已测试恢复流程

### 恢复测试
- [ ] 数据库恢复测试通过
- [ ] 代码回滚流程已验证

---

## 🚀 部署后验证

### 访问测试
- [ ] HTTP 访问正常
- [ ] HTTPS 访问正常
- [ ] 强制 HTTPS 跳转生效
- [ ] 跨域请求正常

### 压力测试
- [ ] 并发用户测试通过（可选）
- [ ] 长时间运行稳定性测试（可选）
- [ ] 内存泄漏检查（可选）

---

## 📝 文档和交接

### 文档完整性
- [ ] 服务器信息已记录（IP、域名、端口等）
- [ ] 账号密码已安全保存
- [ ] API 密钥已记录
- [ ] 部署流程已文档化
- [ ] 故障排查手册已准备

### 团队交接
- [ ] 相关人员已培训
- [ ] 管理后台访问权限已分配
- [ ] 紧急联系方式已确认

---

## ⚠️ 常见问题检查

### 如果遇到 502 错误
- [ ] 检查后端是否运行：`pm2 status`
- [ ] 检查端口是否正确：`netstat -tlnp | grep 5000`
- [ ] 检查 Nginx 配置是否正确
- [ ] 查看后端日志：`pm2 logs liuyao-server`

### 如果数据库连接失败
- [ ] 检查 MySQL 是否运行：`systemctl status mysql`
- [ ] 检查 `.env` 中的数据库配置
- [ ] 测试数据库连接：`mysql -u liuyao_user -p`
- [ ] 查看 MySQL 错误日志

### 如果前端无法访问
- [ ] 检查 Nginx 是否运行：`systemctl status nginx`
- [ ] 检查前端文件路径是否正确
- [ ] 检查文件权限：`ls -la /var/www/liuyao/client/dist`
- [ ] 查看 Nginx 错误日志

---

## ✅ 最终确认

- [ ] 所有功能已测试通过
- [ ] 所有安全措施已实施
- [ ] 监控和告警已配置
- [ ] 备份策略已执行
- [ ] 文档已完善
- [ ] 团队已交接

**部署完成日期**: __________

**部署负责人**: __________

**验收人**: __________

---

## 📞 紧急联系

- **服务器管理员**: __________
- **数据库管理员**: __________
- **开发团队**: __________
- **运维团队**: __________

---

**提示**: 请将此清单打印并在部署过程中逐项检查，确保不遗漏任何重要步骤！
